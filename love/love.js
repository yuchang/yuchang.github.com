(function(k){function f(a,b){return a+Math.floor(Math.random()*(b-a+1))}function u(a,b){var c=a[0].mul((1-b)*(1-b)),d=a[1].mul(2*b*(1-b)),e=a[2].mul(b*b);return c.add(d).add(e)}Point=function(a,b){this.x=a||0;this.y=b||0};Point.prototype={clone:function(){return new Point(this.x,this.y)},add:function(a){p=this.clone();p.x+=a.x;p.y+=a.y;return p},sub:function(a){p=this.clone();p.x-=a.x;p.y-=a.y;return p},div:function(a){p=this.clone();p.x/=a;p.y/=a;return p},mul:function(a){p=this.clone();p.x*=a;p.y*= a;return p}};Heart=function(){for(var a=[],b,c,d=10;30>d;d+=0.2)c=d/Math.PI,b=16*Math.pow(Math.sin(c),3),c=13*Math.cos(c)-5*Math.cos(2*c)-2*Math.cos(3*c)-Math.cos(4*c),a.push(new Point(b,c));this.points=a;this.length=a.length};Heart.prototype={get:function(a,b){return this.points[a].mul(b||1)}};Seed=function(a,b,c,d){this.tree=a;c=c||1;d=d||"#FF0000";this.heart={point:b,scale:c,color:d,figure:new Heart};this.cirle={point:b,scale:c,color:d,radius:5}};Seed.prototype={draw:function(){this.drawHeart(); this.drawText()},addPosition:function(a,b){this.cirle.point=this.cirle.point.add(new Point(a,b))},canMove:function(){return this.cirle.point.y<this.tree.height+20},move:function(a,b){this.clear();this.drawCirle();this.addPosition(a,b)},canScale:function(){return 0.2<this.heart.scale},setHeartScale:function(a){this.heart.scale*=a},scale:function(a){this.clear();this.drawCirle();this.drawHeart();this.setHeartScale(a)},drawHeart:function(){var a=this.tree.ctx,b=this.heart,c=b.point,d=b.color,e=b.scale; a.save();a.fillStyle=d;a.translate(c.x,c.y);a.beginPath();a.moveTo(0,0);for(c=0;c<b.figure.length;c++)d=b.figure.get(c,e),a.lineTo(d.x,-d.y);a.closePath();a.fill();a.restore()},drawCirle:function(){var a=this.tree.ctx,b=this.cirle,c=b.point,d=b.color,e=b.scale,b=b.radius;a.save();a.fillStyle=d;a.translate(c.x,c.y);a.scale(e,e);a.beginPath();a.moveTo(0,0);a.arc(0,0,b,0,2*Math.PI);a.closePath();a.fill();a.restore()},drawText:function(){var a=this.tree.ctx,b=this.heart,c=b.point,d=b.color,b=b.scale; a.save();a.strokeStyle=d;a.fillStyle=d;a.translate(c.x,c.y);a.scale(b,b);a.moveTo(0,0);a.lineTo(15,15);a.lineTo(60,15);a.stroke();a.moveTo(0,0);a.scale(0.75,0.75);a.font="12px \u5fae\u8f6f\u96c5\u9ed1,Verdana";a.fillText("\u70b9\u6211\u70b9\u6211~",23,16);a.restore()},clear:function(){var a=this.tree.ctx,b=this.cirle,c=b.point,b=h=26*b.scale;a.clearRect(c.x-b,c.y-h,4*b,4*h)},hover:function(a,b){return 255==this.tree.ctx.getImageData(a,b,1,1).data[3]}};Footer=function(a,b,c,d){this.tree=a;this.point= new Point(a.seed.heart.point.x,a.height-c/2);this.width=b;this.height=c;this.speed=d||2;this.length=0};Footer.prototype={draw:function(){var a=this.tree.ctx,b=this.point,c=this.length/2;a.save();a.strokeStyle="rgb(35, 31, 32)";a.lineWidth=this.height;a.lineCap="round";a.lineJoin="round";a.translate(b.x,b.y);a.beginPath();a.moveTo(0,0);a.lineTo(c,0);a.lineTo(-c,0);a.stroke();a.restore();this.length<this.width&&(this.length+=this.speed)}};Tree=function(a,b,c,d){this.canvas=a;this.ctx=a.getContext("2d"); this.width=b;this.height=c;this.opt=d||{};this.record={};this.initSeed();this.initFooter();this.initBranch();this.initBloom()};Tree.prototype={initSeed:function(){var a=this.opt.seed||{},b=new Point(a.x||this.width/2,a.y||this.height/2);this.seed=new Seed(this,b,a.scale||1,a.color||"#FF0000")},initFooter:function(){var a=this.opt.footer||{};this.footer=new Footer(this,a.width||this.width,a.height||5,a.speed||2)},initBranch:function(){var a=this.opt.branch||[];this.branchs=[];this.addBranchs(a)},initBloom:function(){for(var a= this.opt.bloom||{},b=[],c=a.num||500,d=a.width||this.width,a=a.height||this.height,e=this.seed.heart.figure,g=0;g<c;g++)b.push(this.createBloom(d,a,240,e));this.blooms=[];this.bloomsCache=b},toDataURL:function(a){return this.canvas.toDataURL(a)},draw:function(a){var b=this.ctx,c=this.record[a];c&&(a=c.point,c=c.image,b.save(),b.putImageData(c,a.x,a.y),b.restore())},addBranch:function(a){this.branchs.push(a)},addBranchs:function(a){for(var b,c,d,e,g,q,f=0;f<a.length;f++)b=a[f],c=new Point(b[0],b[1]), d=new Point(b[2],b[3]),e=new Point(b[4],b[5]),g=b[6],q=b[7],b=b[8],this.addBranch(new Branch(this,c,d,e,g,q,b))},removeBranch:function(a){for(var b=this.branchs,c=0;c<b.length;c++)b[c]===a&&b.splice(c,1)},canGrow:function(){return!!this.branchs.length},grow:function(){for(var a=this.branchs,b=0;b<a.length;b++){var c=a[b];c&&c.grow()}},addBloom:function(a){this.blooms.push(a)},removeBloom:function(a){for(var b=this.blooms,c=0;c<b.length;c++)b[c]===a&&b.splice(c,1)},createBloom:function(a,b,c,d,e,g, q,r,n,k){for(var s,t;;){s=f(20,a-20);t=f(20,b-20);var m=s-a/2,l=b-(b-40)/2-t;if(0>(m/c*(m/c)+l/c*(l/c)-1)*(m/c*(m/c)+l/c*(l/c)-1)*(m/c*(m/c)+l/c*(l/c)-1)-m/c*(m/c)*(l/c)*(l/c)*(l/c))return new Bloom(this,new Point(s,t),d,e,g,q,r,n,k)}},canFlower:function(){return!!this.blooms.length},flower:function(a){a=this.bloomsCache.splice(0,a);for(var b=0;b<a.length;b++)this.addBloom(a[b]);a=this.blooms;for(b=0;b<a.length;b++)a[b].flower()},snapshot:function(a,b,c,d,e){var g=this.ctx.getImageData(b,c,d,e);this.record[a]= {image:g,point:new Point(b,c),width:d,height:e}},setSpeed:function(a,b){this.record[a||"move"].speed=b},move:function(a,b,c){var d=this.ctx;a=this.record[a||"move"];var e=a.point,g=a.image,f=a.speed||10,k=a.width,n=a.height;i=e.x+f<b?e.x+f:b;j=e.y+f<c?e.y+f:c;d.save();d.clearRect(e.x,e.y,k,n);d.putImageData(g,i,j);d.restore();a.point=new Point(i,j);a.speed=0.95*f;2>a.speed&&(a.speed=2);return i<b||j<c},jump:function(){var a=this.blooms;if(a.length)for(var b=0;b<a.length;b++)a[b].jump();if(a.length&& 3>a.length||!a.length)for(var b=this.opt.bloom||{},c=b.width||this.width,d=b.height||this.height,e=this.seed.heart.figure,b=0;b<f(1,2);b++)a.push(this.createBloom(c/2+c,d,240,e,null,1,null,1,new Point(f(-100,600),720),f(200,300)))}};Branch=function(a,b,c,d,e,f,k){this.tree=a;this.point1=b;this.point2=c;this.point3=d;this.radius=e;this.length=f||100;this.len=0;this.t=1/(this.length-1);this.branchs=k||[]};Branch.prototype={grow:function(){var a;this.len<=this.length?(a=u([this.point1,this.point2,this.point3], this.len*this.t),this.draw(a),this.len+=1,this.radius*=0.97):(this.tree.removeBranch(this),this.tree.addBranchs(this.branchs))},draw:function(a){var b=this.tree.ctx;b.save();b.beginPath();b.fillStyle="rgb(35, 31, 32)";b.shadowColor="rgb(35, 31, 32)";b.shadowBlur=2;b.moveTo(a.x,a.y);b.arc(a.x,a.y,this.radius,0,2*Math.PI);b.closePath();b.fill();b.restore()}};Bloom=function(a,b,c,d,e,g,k,r,n){this.tree=a;this.point=b;this.color=d||"rgb(255,"+f(0,255)+","+f(0,255)+")";this.alpha=e||f(0.3,1);this.angle= g||f(0,360);this.scale=k||0.1;this.place=r;this.speed=n;this.figure=c};Bloom.prototype={setFigure:function(a){this.figure=a},flower:function(){this.draw();this.scale+=0.1;1<this.scale&&this.tree.removeBloom(this)},draw:function(){var a=this.tree.ctx,b=this.figure;a.save();a.fillStyle=this.color;a.globalAlpha=this.alpha;a.translate(this.point.x,this.point.y);a.scale(this.scale,this.scale);a.rotate(this.angle);a.beginPath();a.moveTo(0,0);for(var c=0;c<b.length;c++){var d=b.get(c);a.lineTo(d.x,-d.y)}a.closePath(); a.fill();a.restore()},jump:function(){var a=this.tree.height;-20>this.point.x||this.point.y>a+20?this.tree.removeBloom(this):(this.draw(),this.point=this.place.sub(this.point).div(this.speed).add(this.point),this.angle+=0.05,this.speed-=1)}};k.random=f;k.bezier=u;k.Point=Point;k.Tree=Tree})(window);